/*!
 * @maptalks/gltf-layer v0.36.1
 * LICENSE : UNLICENSED
 * (c) 2016-2023 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("@maptalks/gl")):"function"==typeof define&&define.amd?define(["exports","maptalks","@maptalks/gl"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks=t.maptalks||{},t.maptalks,t.maptalksgl)}(this,(function(t,e,n){"use strict";function s(t){if(t&&t.t)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var s=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,s.get?s:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var i=s(e),r=s(n);const o='function(t){var e="undefined"!=typeof Float32Array?Float32Array:Array;function n(t,e,n){var r=e[0],s=e[1],i=e[2],o=e[3],a=e[4],c=e[5],u=e[6],f=e[7],h=e[8],l=e[9],d=e[10],m=e[11],g=e[12],_=e[13],b=e[14],y=e[15],p=n[0],w=n[1],A=n[2],T=n[3];return t[0]=p*r+w*a+A*h+T*g,t[1]=p*s+w*c+A*l+T*_,t[2]=p*i+w*u+A*d+T*b,t[3]=p*o+w*f+A*m+T*y,p=n[4],w=n[5],A=n[6],T=n[7],t[4]=p*r+w*a+A*h+T*g,t[5]=p*s+w*c+A*l+T*_,t[6]=p*i+w*u+A*d+T*b,t[7]=p*o+w*f+A*m+T*y,p=n[8],w=n[9],A=n[10],T=n[11],t[8]=p*r+w*a+A*h+T*g,t[9]=p*s+w*c+A*l+T*_,t[10]=p*i+w*u+A*d+T*b,t[11]=p*o+w*f+A*m+T*y,p=n[12],w=n[13],A=n[14],T=n[15],t[12]=p*r+w*a+A*h+T*g,t[13]=p*s+w*c+A*l+T*_,t[14]=p*i+w*u+A*d+T*b,t[15]=p*o+w*f+A*m+T*y,t}function r(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,n,r){var s=new e(3);return s[0]=t,s[1]=n,s[2]=r,s}function i(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function o(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function a(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function c(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function u(t,e,n,r,s){return t[0]=e,t[1]=n,t[2]=r,t[3]=s,t}function f(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function h(t,e,n,r){var s=e[0],i=e[1],o=e[2],a=e[3],c=n[0],u=n[1],f=n[2],h=n[3],l=void 0,d=void 0,m=void 0,g=void 0,_=void 0;return(d=s*c+i*u+o*f+a*h)<0&&(d=-d,c=-c,u=-u,f=-f,h=-h),1-d>1e-6?(l=Math.acos(d),m=Math.sin(l),g=Math.sin((1-r)*l)/m,_=Math.sin(r*l)/m):(g=1-r,_=r),t[0]=g*s+_*c,t[1]=g*i+_*u,t[2]=g*o+_*f,t[3]=g*a+_*h,t}r(),function(){var t,n=(t=new e(4),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var l,d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};r(),s(1,0,0),s(0,1,0),f(),f(),l=new e(9),e!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[5]=0,l[6]=0,l[7]=0),l[0]=1,l[4]=1,l[8]=1;\n/*!\n   * @maptalks/gltf-loader v0.27.2\n   * LICENSE : UNLICENSED\n   * (c) 2016-2022 maptalks.org\n   */\nlet m=0;function g(t){return null==t}function _(t){return!g(t)}function b(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function y(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView\'s component type: "+t)}function p(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function w(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),n=e.length,r=new Uint8Array(n);for(let t=0;t<n;t++)r[t]=e.charCodeAt(t);return r.buffer}const A=[],T=[],I=[],x=[0,0,0],M=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),v=[1,1,1];function E(t,e,n,r,s,i,o){const a=y(o);if((0===s||s===r*a.BYTES_PER_ELEMENT)&&i%a.BYTES_PER_ELEMENT==0){const s=new a(e,i,n*r);return t.set(s),t}0===s&&(s=r*a.BYTES_PER_ELEMENT);const c=new Uint8Array(r*a.BYTES_PER_ELEMENT);for(let o=0;o<n;o++){let n=null;const u=new Uint8Array(e,s*o+i,r*a.BYTES_PER_ELEMENT);c.set(u),n=new a(c.buffer,0,r);for(let e=0;e<r;e++)t[o*r+e]=n[e]}return t}const O="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function P(t,e,n){const r=new Uint8Array(t,e,n);return O.decode(r)}const k={get:function(t,e={}){e||(e={});const n=new AbortController,r=n.signal,s=b({},e);s.signal=r,s.method||(s.method="GET");const i=fetch(t,s).then((t=>{const n=this.t(t,e.responseType);return n.message?n:n.then((n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return i.xhr=n,i},t:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={})=>(e||(e={}),e.responseType="arraybuffer",k.get(t,e)),getJSON:function(t,e={}){return e&&e.jsonp?k.jsonp(t):((e=e||{}).responseType="json",k.get(t,e))},jsonp:function(t){const e="_maptalks_jsonp_"+m++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise((t=>{window[e]=function(r){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(r)},document.getElementsByTagName("head")[0].appendChild(n)}))}};class N{constructor(t,e,n){this.i=t,this.decoders=e,this.o=n,this.images={},this.u={}}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const r=this.buffers[t.id],s=this.h(e,r);return this.getImageByBuffer(s,n)}if(this.u[t.id])return this.u[t.id].then((()=>{const r=this.buffers[t.id],s=this.h(e,r);return this.getImageByBuffer(s,n)}));if(p(t.uri)){const r=this.buffers[t.id]=w(t.uri),s=this.h(e,r);return this.getImageByBuffer(s,n)}return this.u[t.id]=k.getArrayBuffer(t.uri,null).then((r=>{const s=this.buffers[t.id]=r.data,i=this.h(e,s);return this.getImageByBuffer(i,n)}))}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;if(n[e.mimeType])return n[e.mimeType](t,{supportedFormats:this.o});if("image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType)return console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null);{const n=new Blob([t],{type:e.mimeType}),r=URL.createObjectURL(n);return this.l(e.id,r)}}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this.u[t.id]?this.u[t.id].then((()=>this.images[t.id])):this.u[t.id]=this.l(t.id,e)}l(t,e){return new Promise(((n,r)=>{this.i(e,((s,i)=>{s?r(s):(URL.revokeObjectURL(e),this.images[t]=i,n(this.images[t]))}))}))}}const S=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16];class R{constructor(t,e,n){this.rootPath=t,this.gltf=e,this.m=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this.g()}_(t,e){const n=this.gltf,r=n.accessors[e];if(void 0===r.bufferView)return this.accessors[r.id]=this.p(t,e,null,0),Promise.resolve(this.accessors[r.id]);if(r&&this.accessors[r.id])return Promise.resolve(this.accessors[r.id]);const s=n.bufferViews[r.bufferView];return this.A(s).then((n=>{const{buffer:s,byteOffset:i}=n;return this.accessors[r.id]=this.p(t,e,s,i)}))}A(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(p(e.uri)){const t=this.buffers[e.id]=w(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=k.getArrayBuffer(t,null).then((r=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=r.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}p(t,e,n,r=0){const s=this.gltf,i=s.accessors[e],o=void 0!==i.bufferView?s.bufferViews[i.bufferView]:{},a=(o.byteOffset||0)+r,c=this.T(i.type),u=y(i.componentType),f=o.byteStride||0,h={array:void 0,name:t,accessorName:e,byteLength:i.count*c*u.BYTES_PER_ELEMENT,componentType:i.componentType,count:i.count,type:i.type,itemSize:c};if(i.min&&(h.min=i.min),i.max&&(h.max=i.max),n)if(this.m)h.byteStride=f,h.byteOffset=a+(i.byteOffset||0),!f||f===c*u.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(h.array=this.I(n,i.count,c,a+(i.byteOffset||0),u),h.array.buffer.byteLength===h.byteLength&&(h.byteOffset=0)):h.array=new Uint8Array(n,a,o.byteLength);else if(i.interleaved){h.byteStride=0,h.byteOffset=0;const t=new u(i.count*c);h.array=E(t,n,i.count,c,f,a+(i.byteOffset||0),i.componentType)}else h.byteStride=0,h.array=this.I(n,i.count,c,a+(i.byteOffset||0),u),h.byteOffset=h.array.byteOffset;else{h.array=new u(i.count);const t=h.min||h.max;t&&(h.array[0]=t[0],h.array[1]=t[1],h.array[2]=t[2])}return h}g(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}I(t,e,n,r,s){return r%s.BYTES_PER_ELEMENT!=0&&(t=t.slice(r,r+e*n*s.BYTES_PER_ELEMENT),r=0),new s(t,r,n*e)}T(t){const e=S.indexOf(t);return S[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this.A(e).then((r=>{const{buffer:s,byteOffset:i}=r,o=P(s,i+(e.byteOffset||0),n);return t.content=o,t}))}if(t.uri){if(p(t.uri)){const e=w(t.uri),n=P(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return k.get(e).then((e=>(t.content=e,t)))}}return Promise.resolve(t)}));return Promise.all(n).then((()=>t))}}class B extends N{constructor(t,e,n,r,s,i){super(r,s,i),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new R(t,e,n)}iterate(t,e){const n=this.gltf[e];if(!n)return;let r=0;for(const e in n)t(e,n[e],r++)}createNode(t){const e={};if(_(t.name)&&(e.name=t.name),_(t.children)&&(e.children=t.children),_(t.jointName)&&(e.jointName=t.jointName),_(t.matrix)&&(e.matrix=t.matrix),_(t.rotation)&&(e.rotation=t.rotation),_(t.scale)&&(e.scale=t.scale),_(t.translation)&&(e.translation=t.translation),_(t.extras)&&(e.extras=t.extras),_(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const r=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(A,e.translation||x),s=function(t,e){var n=e[0],r=e[1],s=e[2],i=e[3],o=n+n,a=r+r,c=s+s,u=n*o,f=r*o,h=r*a,l=s*o,d=s*a,m=s*c,g=i*o,_=i*a,b=i*c;return t[0]=1-h-m,t[1]=f+b,t[2]=l-_,t[3]=0,t[4]=f-b,t[5]=1-u-m,t[6]=d+g,t[7]=0,t[8]=l+_,t[9]=d-g,t[10]=1-u-h,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(T,e.rotation||M),i=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(I,e.scale||v);return n(i,s,i),n(t,r,i)}return function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}M(t){const e={};for(const n in t){const r=t[n];let s,i;r.instanceTechnique&&r.instanceTechnique.values?(s=r.instanceTechnique,i=s.values.diffuse):(s=r,i=s.values.tex||s.values.diffuseTex||s.values.diffuse);const o={baseColorTexture:{index:i}};r.name&&(o.name=r.name),r.extensions&&(o.extensions=r.extensions),r.extras&&(o.extras=r.extras),e[n]=o}return e}v(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],r=(n.byteOffset||0)+this.glbBuffer.byteOffset,s=n.byteLength,i=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,r,s);return this.getImageByBuffer(i,t)}return this.requestExternalImage(t)}O(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this.v(n).then((t=>{const r=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:r}}))}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,r;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,r=n.values.diffuse):(n=e,r=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===r||void 0===this.gltf.textures)return null;const s=this.gltf.textures[r];if(!s)return null;const i=this.gltf.samplers[s.sampler];return{format:s.format||6408,internalFormat:s.internalFormat||6408,type:s.type||5121,sampler:i,source:this.gltf.images[s.source]}}getMaterial(){return null}getAnimations(){return null}}class C extends N{constructor(t,e,n,r,s,i){super(r,s,i),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new R(t,e,n)}iterate(t,e){const n=this.gltf[e];if(n)for(let e=0;e<n.length;e++)t(e,n[e],e)}createNode(t){const e={};return b(e,t),!_(t.weights)&&this.gltf.meshes&&_(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}O(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this.v(n).then((t=>{if(!t)return null;const r={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extensions:n.extensions,extras:n.extras}};b(r,e);const s=_(e.sampler)?this.gltf.samplers[e.sampler]:void 0;return s&&(r.sampler=s),t.format&&(r.format=t.format),r}))}v(t){if(!_(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this.P(e,t)}return null}P(t,e){const n=this.h(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}h(t,e,n){n=n||0;const r=t.byteOffset+n,s=t.byteLength;return new Uint8Array(e,r,s)}k(t,e){const n=new Array(t.byteLength);for(let e=0;e<t.byteLength;e++)n[e]=String.fromCharCode(t[e]);return n.join(""),"data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(n)))}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t}))}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(_(t[n].input)||_(t[n].output))&&(e.push(this.accessor._("input",t[n].input)),e.push(this.accessor._("output",t[n].output)));return Promise.all(e).then((e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t}))}}const U="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class L{static read(t,e=0,n=0){n||(n=t.byteLength);const r=new DataView(t,e,n),s=r.getUint32(4,!0);if(1===s)return L.readV1(r,e);if(2===s)return L.readV2(t,e);throw new Error("Unsupported glb version : "+s)}static readV1(t,e){const n=t.getUint32(8,!0),r=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb\'s byte length.");const s=D(t.buffer,20+e,r);return{json:JSON.parse(s),glbBuffer:{byteOffset:20+e+r,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,r,s;const i=new DataView(t,e+12);let o=0;for(;o<i.byteLength;){const a=i.getUint32(o,!0);o+=4;const c=i.getUint32(o,!0);if(o+=4,1313821514===c)n=D(t,e+12+o,a);else if(5130562===c){s=e+12+o,r=a;break}o+=a}return{json:JSON.parse(n),glbBuffer:{byteOffset:s,buffer:t,byteLength:r}}}}function D(t,e,n){if(U){const r=new Uint8Array(t,e,n);return U.decode(r)}return function(t){const e=t.length;let n="";for(let r=0;r<e;){let s=t[r++];if(128&s){let n=q[s>>3&7];if(!(64&s)||!n||r+n>e)return null;for(s&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;s=s<<6|63&e}}n+=String.fromCharCode(s)}return n}(new Uint8Array(t,e,n))}const q=[1,1,1,1,2,2,3,0],F=[0,0,0],j=[0,0,0,1],V=[1,1,1],H={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},K={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},$={N(t,e,n,r,s,o,a,c){const u=_(t)?e.animations:[e.animations[0]],f={};for(let e=0;e<u.length;e++){const h=u[e],l=h.name||e;if(_(t)&&l!==t)continue;const m=h.channelsMap[n];if(m)for(let t=0;t<m.length;t++){const e=m[t];"translation"===e.target.path?(this.S(s,h.samplers[e.sampler],r,1),f.translation=i(F,s)):"rotation"===e.target.path?(this.R(o,h.samplers[e.sampler],r,1),f.rotation=d(j,o)):"scale"===e.target.path?(this.S(a,h.samplers[e.sampler],r,1),f.scale=i(V,a)):"weights"===e.target.path&&c&&(this.S(c,h.samplers[e.sampler],r,c.length),f.weights=c)}}return f},S(t,e,n,r){switch(e.interpolation){case"LINEAR":{const s=this.B(K,e,n,1*r);s&&(t=function(t,e,n,r){for(let s=0;s<t.length;s++)t[s]=e[s]+r*(n[s]-e[s]);return t}(t,s.PREVIOUS,s.NEXT,s.INTERPOLATION));break}case"STEP":{const s=this.B(K,e,n,1*r);s&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...s.PREVIOUS));break}case"CUBICSPLINE":{const s=this.B(K,e,n,3*r);s&&(t=this.C(t,s,e.input.array,3*r));break}}return t},R(t,e,n){switch(e.interpolation){case"LINEAR":{const r=this.B(K,e,n,1);r&&h(t,r.PREVIOUS,r.NEXT,r.INTERPOLATION);break}case"STEP":{const r=this.B(K,e,n,1);r&&(t=u(t,...r.PREVIOUS));break}case"CUBICSPLINE":{const r=this.B(K,e,n,3);if(r){for(let t=0;t<r.PREVIOUS.length;t++)r.PREVIOUS[t]=Math.acos(r.PREVIOUS[t]),r.NEXT[t]=Math.acos(r.NEXT[t]);t=this.C(t,r,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},U(t,e){const n=t.length;let r,s,i,o=0,a=n-1,c=Math.floor((o+a)/2);for(;o<=n-1&&a>=0;){if(o===a)return null;if(t[c]<=e&&e<=t[c+1]){const n=t[c];return r=c,s=c+1,i=(e-n)/(t[c+1]-n),{preIndx:r,nextIndex:s,interpolation:i}}e<t[c]?(a=c,c=Math.floor((o+a)/2)):t[c+1]<e&&(o=c,c=Math.floor((o+a)/2))}return null},B(t,e,n,r){const s=e.input.array,i=e.output.array,o=e.output.itemSize;(n<s[0]||n>s[s.length-1])&&(n=Math.max(s[0],Math.min(s[s.length-1],n))),n===s[s.length-1]&&(n=s[0]);const a=this.U(s,n);if(!a||!a.nextIndex)return null;const{preIndx:c,nextIndex:u,interpolation:f}=a;t.PREINDEX=c,t.NEXTINDEX=u,t.INTERPOLATION=f;const h=o*r;return t.PREVIOUS=i.subarray(t.PREINDEX*h,(t.PREINDEX+1)*h),t.NEXT=i.subarray(t.NEXTINDEX*h,(t.NEXTINDEX+1)*h),t},C(t,e,n,r){const s=e.INTERPOLATION,i=n[e.PREINDEX],o=n[e.NEXTINDEX];for(let n=0;n<3;n++){const a=e.PREVIOUS[r+n],c=(o-i)*e.PREVIOUS[2*r+n],u=e.NEXT[3+n],f=(o-i)*e.NEXT[n],h=(2*Math.pow(s,3)-3*Math.pow(s,2)+1)*a+(Math.pow(s,3)-2*Math.pow(s,2)+s)*c+(2*-Math.pow(s,3)+3*Math.pow(s,2))*u+(Math.pow(s,3)-Math.pow(s,2))*f;t[n]=h}return t},getAnimationClip(t,e,n,r){const s=t.nodes[e]&&t.nodes[e].weights;return o(F,...H.TRANSLATION),u(j,...H.ROTATION),o(V,...H.SCALE),this.N(r,t,e,n,F,j,V,s)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,n)=>{let r=-1/0,s=1/0;const i=e.channels;for(let t=0;t<i.length;t++){const n=i[t],o=e.samplers[n.sampler].input.array;o[o.length-1]>r&&(r=o[o.length-1]),o[0]<s&&(s=o[0])}const o=e.name||n;t.timeSpan[o]={max:r,min:s}})),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?_(e)?n[e]:n[Object.keys(n)[0]]:null}};let G=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(rt){}t&&"undefined"!=typeof createImageBitmap&&(G=!0)}const X="undefined"==typeof document?null:document.createElement("canvas");class z{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:r}=L.read(e.buffer,e.byteOffset,e.byteLength);this.L(t,n,r)}else this.L(t,e);this.D=new R(this.rootPath,this.gltf,this.glbBuffer),this.q()}q(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders.ktx2)throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded")}}F(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this.D.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}load(t){t=t||{};const e=this.j(t),n=this.V(),r=this.H(),s=this.F();return Promise.all([e,n,r,s]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let t=0;t<e.length;t++){const n=e[t];n.channelsMap={};for(let t=0;t<n.channels.length;t++){const e=n.channels[t];n.channelsMap[e.target.node]||(n.channelsMap[e.target.node]=[]),n.channelsMap[e.target.node].push(e)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let n=0;n<e.length;n++)e[n].uri&&e[n].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[n].uri});for(let e=0;e<n.length;e++)n[e].uri&&n[e].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[e].uri})}return t}static getAnimationClip(t,e,n,r){return $.getAnimationClip(t,e,n,r)}static getAnimationTimeSpan(t,e){return $.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return y(t)}static readInterleavedArray(t,e,n,r,s,i,o){return E(t,e,n,r,s,i,o)}L(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=G?Y.bind(this):this.options.requestImage||J,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new C(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{}),this.adapter.iterate(((t,e,n)=>{e.id="buffer_"+n}),"buffers"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors")):(this.adapter=new B(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{}),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"))}K(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||function(t){return!g(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}(t.children[0])))return t;const r=t.children.map((t=>{const n=e[t];return n.nodeIndex=t,this.K(n,e)}));t.children=r}var n;return t}j(t){return this.$(t).then((t=>{const e=this.scenes=[];let n;for(const e in t)t[e]=this.K(t[e],t),t[e].nodeIndex=Number(e)?Number(e):e;this.adapter.iterate(((r,s,i)=>{const o={};s.name&&(o.name=s.name),s.nodes&&(o.nodes=s.nodes.map((e=>t[e]))),this.gltf.scene===r&&(n=i),e.push(o)}),"scenes");const r={asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins};if(this.gltf.extensions&&(r.extensions=this.gltf.extensions),1===this.version){const t=this.adapter.M(this.gltf.materials);r.materials=t}return r}))}$(t){return this.G(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,n)=>{const r=this.adapter.createNode(n,this.meshes,this.skins);t[e]=r}),"nodes"),t}))}X(){this.skins=[];const t=[];return this.adapter.iterate(((e,n,r)=>{t.push(this.J(n).then((t=>{t.index=r,this.skins.push(t)})))}),"skins"),t}J(t){const e=t.inverseBindMatrices;return this.adapter.accessor._("inverseBindMatrices",e).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}V(){const t=this.gltf.animations;return _(t)?this.adapter.getAnimations(t):null}G(t){this.meshes={};let e=[];return this.adapter.iterate(((n,r,s)=>{e.push(this.W(r,t).then((t=>{t.index=s,this.meshes[n]=t})))}),"meshes"),e=e.concat(this.X()),Promise.all(e)}W(t,e){const n=t.primitives.map((t=>this.Y(t,e))).filter((t=>!!t));return Promise.all(n).then((e=>{const n={};return b(n,t),n.primitives=e,n}))}H(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter.O(n));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t].image.array;if(e[t]&&n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},r=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[r[t]]=e[t]);return n}return e}))}Y(t,e){let n;const r=[],s=t.extensions;if(_(t.targets))for(let e=0;e<t.targets.length;e++){const n=t.targets[e];for(const t in n){const s=this.adapter.accessor._(`morphTargets_${t}_${e}`,n[t]);s&&r.push(s)}}if(s&&s.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:i,attributes:o}=s.KHR_draco_mesh_compression,a=this.gltf.bufferViews[i],c=this.D.A(a).then((n=>{const{buffer:r,byteOffset:s}=n;let{byteOffset:i,byteLength:c}=a;i||(i=0);const u=new DataView(r,s+i,c),f={attributes:o,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(u,f).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}));r.push(c),n=Promise.all(r)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor._(t,e[t]);n&&r.push(n)}if(_(t.indices)){const e=this.adapter.accessor._("indices",t.indices);e&&r.push(e)}n=Promise.all(r)}return n.then((e=>{if(s&&s.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,r;const i={attributes:e.reduce(((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)r=r||{},r[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:r,array:s}=e,i=s.length/r;for(let e=0;e<i;e++)for(let i=0;i<r;i++){const o=e*r+i;s[o]<t[i]&&(t[i]=s[o]),s[o]>n[i]&&(n[i]=s[o])}if(e.quantization){const r=e.quantization,s=r.range/(1<<r.quantizationBits),i=r.minValues;c(t,t,s),a(t,t,i),c(n,n,s),a(n,n,i)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t}),{}),material:t.material};return n&&(i.indices=n),r&&(i.morphTargets=r),i.mode=_(t.mode)?t.mode:4,_(t.extras)&&(i.extras=t.extras),i}))}}function J(t,e){const n=new Image;n.crossOrigin="",n.onload=()=>{if(!X)return void e(new Error("There is no canvas to draw image!"));X.width=n.width,X.height=n.height;const t=X.getContext("2d",{willReadFrequently:!0});t.drawImage(n,0,0,n.width,n.height);const r=t.getImageData(0,0,n.width,n.height),s={width:n.width,height:n.height,data:new Uint8Array(r.data)};e(null,s)},n.onerror=function(t){e(t)},n.src=t}let W,Q;function Y(t,e){W||(W=new OffscreenCanvas(2,2),Q=W.getContext("2d",{willReadFrequently:!0})),fetch(t).then((t=>t.arrayBuffer())).then((t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then((t=>{let{width:n,height:r}=t;Z(n)||(n=tt(n)),Z(r)||(r=tt(r));const s=this.options.maxTextureSize;s&&(n=Math.min(s,n),r=Math.min(s,r)),W.width=n,W.height=r,Q.drawImage(t,0,0,n,r),t.close();const i=Q.getImageData(0,0,n,r);e(null,{width:n,height:r,data:new Uint8Array(i.data)})})).catch((t=>{console.warn(t),e(t)}))}function Z(t){return 0==(t&t-1)&&0!==t}function tt(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}\n/*!\n   * @maptalks/gl v0.81.0\n   * LICENSE : UNLICENSED\n   * (c) 2016-2023 maptalks.com\n   */const et=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},nt=et(),rt=nt.gl_trans__coders=nt.gl_trans__coders||{};rt.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),s=nt.gl_trans__coders=nt.gl_trans__coders||{};let i=`${r}\\n    const _____getGlobal = ${et.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals[\'gl_trans__coders\'] = g___lobals[\'gl_trans__coders\'] || {};`;for(const t in s)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(i+=\'tran_____scoders["\'+t+\'"] =\'+s[t].toString()+"\\n;");return i+="\\n"+e.substring(r.length),i},rt.registerTranscoder=function(t,e){rt[t]=e},rt.getTranscoder=function(t){return rt[t]};const st={"image/crn":rt.crn&&rt.crn(),"image/ktx2":rt.ktx2&&rt.ktx2(),"image/cttf":rt.ktx2&&rt.ktx2(),"draco":rt.draco&&rt.draco()};let it;const ot={};function at(t,e,n){return new z(t,e,n).load({skipAttributeTransform:!0})}function ct(t,e){const n=e.lastIndexOf("/"),r=e.slice(0,n),s=e.slice(e.lastIndexOf(".")).toLowerCase(),i=ut.bind(this,t);return s.indexOf(".gltf")>-1?function(t,e){return k.getJSON(t,e)}(e,{}).then((t=>t.message?t:at(r,t,{requestImage:i,decoders:st,transferable:!0}))):s.indexOf(".glb")>-1?function(t,e){return k.getArrayBuffer(t,e)}(e,{}).then((t=>t.message?t:at(r,{buffer:t.data,byteOffset:0},{requestImage:i,decoders:st,transferable:!0}))):null}function ut(t,e,n){ot[e]?ot[e].push(n):(ot[e]=[n],self.postMessage({type:"<request>",command:"sendImageData",actorId:t,workerId:it,params:e}))}t.onmessage=function(t){const e=t.data,n=e.url;if("addLayer"===e.command||"removeLayer"===e.command)it=t.workerId,self.postMessage({type:"<response>",actorId:e.actorId,workerId:it,params:"ok"});else if(n)!function(t){const e=t.data,n=t.callback;ct(t.actorId,e.url).then((t=>{t.message?self.postMessage({callback:n,error:t}):self.postMessage({callback:n,data:t},t.transferables)})).catch((t=>{self.postMessage({callback:n,error:t})})),ot.receive=n}(t);else if(e.imageUrl){const t=ot[e.imageUrl];if(delete ot[e.imageUrl],t)for(let n=0;n<t.length;n++)t[n](null,e.result)}},Object.defineProperty(t,"Z",{value:!0})}';function a(t){return null==t}function h(t){return!a(t)}function u(t,e){const n=new Set(e);return Array.from(new Set(t.filter((t=>n.has(t)))))}function c(t,n,s=0){if(!(t&&n instanceof e.Coordinate))return null;const i=t.coordinateToPointAtRes(n,t.getGLRes());return[i.x,i.y,s]}function l(t,e){return Math.abs(t)*Math.sign(e)}
/*!
   * Contains code from THREE.js
   * MIT License
   * https://github.com/mrdoob/three.js
   */for(var f=[],d=0;d<6;d++)f[d]=[];var m=[];function p(t,e,n){var s,i,r,o,a,h,u,c,l,d,p,g,_,v,x,w,T;i=(s=t)[0],r=s[1],o=s[2],a=s[3],h=s[4],u=s[5],c=s[6],l=s[7],d=s[8],p=s[9],g=s[10],_=s[11],v=s[12],x=s[13],w=s[14],T=s[15],b(f[0],a-i,l-h,_-d,T-v),b(f[1],a+i,l+h,_+d,T+v),b(f[2],a+r,l+u,_+p,T+x),b(f[3],a-r,l-u,_-p,T-x),b(f[4],a-o,l-c,_-g,T-w),b(f[5],a+o,l+c,_+g,T+w);for(var O=0;O<6;O++)if(!n||"0"!==n.charAt(O)){var S=f[O];if(m[0]=S[0]>0?e[1][0]:e[0][0],m[1]=S[1]>0?e[1][1]:e[0][1],m[2]=S[2]>0?e[1][2]:e[0][2],y(S,m)<0)return!1}return!0}var g=1/6;function b(t,e,n,s,i){return t[0]=e*g,t[1]=n*g,t[2]=s*g,t[3]=i*g,t}function y(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}const _={};const v="undefined"==typeof document?null:document.createElement("canvas");class x extends i.worker.Actor{constructor(t,e){super(t),this.mapId=e}loadGLTF(t){const e=function(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}(t),n={url:e};return new Promise(((t,e)=>{this.send(n,null,((n,s)=>{n?e(n):t(s)}))}))}sendImageData(t,e){!function(t,e){const n=new Image;n.onload=()=>{if(!v)return void e(new Error("There is no canvas to draw image!"));v.width=n.width,v.height=n.height;const t=v.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const s=t.getImageData(0,0,n.width,n.height),i={width:n.width,height:n.height,data:new Uint8Array(s.data)};e(null,i,[i.data.buffer])},n.onerror=function(t){e(t)},n.src=t}(t,((n,s)=>{n||this.isActive()&&e(null,{result:s,imageUrl:t})}))}addLayer(t,e,n){const s={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}};this.broadcast(s,null,n)}removeLayer(t,e,n){const s={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(s,null,n)}}const w=[],T=[],O=[.2107,-.0202],S=["points","lines","line strip","line loop"];class M extends(n.MaskRendererMixin(i.renderer.OverlayLayerCanvasRenderer)){constructor(t){super(t),this.i={},this.o=[]}onAdd(){super.onAdd(),this.prepareWorker()}draw(t,e){this.prepareCanvas(),this.h(e,t)}drawOnInteracting(t,e,n){this.h(n,e)}h(t,e){let n=0;this.u(t),this.l={},this.m(t);const s=this.p(t);this.g(e);const r=t&&t.renderTarget?t.renderTarget.fbo:null;for(const e in this.i){if("pointline"===e)continue;let o=this.i[e].shader;if(t&&t.includes){const{newShader:e,uniforms:n}=this._(t,o,o.type);o=e,i.Util.extend(s,n)}const a=this.v(e);o.filter=t&&t.sceneFilter||null,this.renderer.render(o,s,a,r),n++}const o=this.v("pointline");if(o.getMeshes().length){s.pointSize=this.layer.options.pointSize||1;const e=this.i.pointline.shader;e.filter=t&&t.sceneFilter||null,this.renderer.render(e,s,o,r),n++}this.T=!0,(!t||t&&t.isFinalRender)&&(this.completeRender(),this.layer.fire("rendercomplete-debug",{count:n})),this.O=t,this.S=e}g(t){this.o.length=0;const e=this.layer.getGeometries();for(let n=0;n<e.length;n++){const s=e[n],r=s.getMeshes(this.M,this.regl,t),o=s.getShader();r.length&&(this.o.push(s),this.l[o]=this.l[o]||[],i.Util.pushIn(this.l[o],r))}}p(t){const e={};this.A.outSize=[this.canvas.width,this.canvas.height],this.A.halton=t?t.jitter||[0,0]:O,i.Util.extend(e,this.A);const n=this.getMaskUniforms();return i.Util.extend(e,n),e}v(t){const e=[],s=[];if("pointline"===t){for(const t in this.l){this.l[t].forEach((t=>{S.indexOf(t.geometry.desc.primitive)>-1&&e.push(t)}))}const t=new n.reshader.Scene(e);return t.sortMeshes(this.A.cameraPosition),t}for(const e in this.l){const n=this.l[e];e===t&&n.forEach((t=>{S.indexOf(t.geometry.desc.primitive)<0&&s.push(t)}))}const i=new n.reshader.Scene(s);return i.sortMeshes(this.A.cameraPosition),i}needToRedraw(){if(super.needToRedraw())return!0;const t=this.layer.getGeometries();for(let e=0;e<t.length;e++)if(this.o.indexOf(t[e])>-1&&(t[e].isDirty()||t[e].isAnimated()))return!0;return!1}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),super.onRemove()}hitDetect(){return!1}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.I(this.canvas,t),this.regl=n.createREGL({gl:this.gl,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_s3tc"]})}t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.M=this.regl.gltfManager=this.regl.gltfManager||this.P(),this.k(),this.N&&this.N.forEach((t=>{t.generateInstancedBuffers(this.regl)})),this.C&&this.C.forEach((t=>{t.generateBuffers(this.regl)})),this.layer.fire("contextcreate",{regl:this.regl})}L(){return this.M}P(){return new n.reshader.GLTFManager(this.regl,(t=>this.workerConn.loadGLTF(t).then((t=>(this.setToRedraw(),this.R=!0,t))).catch((e=>{console.error(e),this.layer.fire("modelerror",{type:"modelerror",url:t,info:e})}))))}k(){const t=this.layer.getMap(),e=new n.reshader.Renderer(this.regl);this.renderer=e,this.A={"projMatrix":t.projMatrix,"projViewMatrix":t.projViewMatrix,"viewMatrix":t.viewMatrix,"cameraPosition":t.cameraPosition,"altitudeScale":1},n.reshader.pbr.PBRUtils.loginIBLResOnCanvas(this.canvas,this.regl,t),this.B=new n.reshader.FBORayPicking(e,{vert:"#include <gl2_vert>\n\nattribute vec3 aPosition;\n\nuniform mat4 projViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform float pointSize;\n\n#include <fbo_picking_vert>\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projViewMatrix * modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    gl_PointSize = pointSize;\n\n    fbo_picking_setData(gl_Position.w, true);\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return n.mat4.multiply([],e.projViewMatrix,e.modelMatrix)}}]},this.pickingFBO,t)}prepareWorker(){const t=this.layer.getMap();this.workerConn||(this.workerConn=new x("@maptalks/gltf-layer",t.id));const e=this.workerConn;if(!e.isActive())return;const n=this.layer.options||{},s=this.layer.getId();e.addLayer(s,{markerType:n.markerTypes,pointSize:n.pointSize},(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}m(t){const e=_;for(const n in e){if(this.i[n])continue;const s=e[n];this.F(t,s.name,s.type,s.config)}}F(t,e,s,r){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),r.extraCommandProps||(r.extraCommandProps={});const o={};t&&this.U(o,w,t);const a=i.Util.extend({},r);a.extraCommandProps=i.Util.extend({},r.extraCommandProps),a.extraCommandProps.viewport=this.viewport,a.uniforms=i.Util.extend([],r.uniforms,w),a.defines=i.Util.extend({},a.defines,o),s.indexOf(".")>-1?(s=s.split("."),this.i[e]={shader:new n.reshader[s[0]][s[1]](a),type:s}):this.i[e]={shader:new n.reshader[s](a),type:s}}remove(){this.j();const t=this.i;for(const e in t)t[e].shader.dispose();this.extentShader&&this.extentShader.dispose(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}resizeCanvas(t){super.resizeCanvas(t),this.pickingFBO&&this.pickingFBO.resize(this.canvas.width,this.canvas.height),this.layer.fire("resizecanvas",{size:t})}getFrameTimestamp(){return this.S}getFrameContext(){return this.O}supportRenderMode(){return!0}needRetireFrames(){return this.R}U(t,e,n){const s=n&&n.includes;if(s)for(const r in s)s[r]&&(n[r].uniformDeclares&&(e.length=0,e.push(...n[r].uniformDeclares)),n[r].defines&&i.Util.extend(t,n[r].defines))}D(t,e){const n=e&&e.includes;if(n)for(const s in n)n[s]&&e[s].renderUniforms&&i.Util.extend(t,e[s].renderUniforms)}_(t,e,s){const r={},o={};this.U(r,w,t),this.D(o,t);const a={vert:e.vert,frag:e.frag,uniforms:e.uniforms,extraCommandProps:e.extraCommandProps};a.defines=r,a.uniforms=i.Util.extend([],a.uniforms,w);let h=null;return t.states.includesChanged?(h=Array.isArray(s)?new n.reshader[s[0]][s[1]](a):new n.reshader[s](a),e.dispose()):h=e,{uniforms:o,newShader:h}}V(t,e,n){if(t.viewshed){for(const e in t.viewshed.renderUniforms)n[e]=t.viewshed.renderUniforms[e];i.Util.extend(e.shaderDefines,t.viewshed.defines)}if(t.floodAnalysis){for(const e in t.floodAnalysis.renderUniforms)n[e]=t.floodAnalysis.renderUniforms[e];i.Util.extend(e.shaderDefines,t.floodAnalysis.defines)}return n}getShadowMeshes(){const t=[];if(!this.layer||!this.layer.isVisible()||!this.l)return t;const e=this.layer.getGeometries();for(let n=0;n<e.length;n++)if(e[n].isCastShadow()&&e[n].isVisible()&&e[n].q()){const s=e[n].G||[];i.Util.pushIn(t,s)}return t}J(){const t=[];if(!Object.keys(this.l).length)return t;for(const e in this.l)i.Util.pushIn(t,this.l[e]);return t}getAnalysisMeshes(){return this.J()}drawOutline(t){this.extentShader||(this.extentShader=new n.reshader.MeshShader({vert:"attribute vec3 aPosition;\n\nattribute float aOutline;\n\nuniform mat4 projViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform float instance;\n\n#include <get_output>\n\n\n\nvarying float vOutline;\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projViewMatrix * modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    if (instance == 0.0) {\n\n        vOutline = 1.0;\n\n    } else {\n\n        vOutline = aOutline;\n\n    }\n\n}\n\n",frag:"precision highp float;\n\nvarying float vOutline;\n\nvoid main() {\n\n    gl_FragColor = vec4(vOutline);\n\n}\n\n",positionAttribute:"POSITION",extraCommandProps:{viewport:this.viewport,cull:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}));const e=this.getOutlineMeshes();e.length&&(this.X=this.X||new n.reshader.Scene,this.X.setMeshes(e),this.renderer.render(this.extentShader,{"projViewMatrix":this.A.projViewMatrix},this.X,t))}getOutlineMeshes(){const t=[];if(!this.layer)return t;const e=this.layer.getGeometries();for(let n=0;n<e.length;n++)if(e[n].isOutline()&&e[n].isVisible()&&e[n].q()){const s=e[n].G||[];i.Util.pushIn(t,s)}return t}j(){this.canvas&&n.reshader.pbr.PBRUtils.logoutIBLResOnCanvas(this.canvas,this.getMap())}u(t){const e=this.layer.getMap(),{iblTexes:s,dfgLUT:r}=n.reshader.pbr.PBRUtils.getIBLResOnCanvas(this.canvas);if(e&&e.getLights()){const o=n.reshader.pbr.PBRUtils.getPBRUniforms(e,s,r,t&&t.ssr,t&&t.jitter),a=e.getLights(),h=a.ambient&&a.ambient.color?a.ambient.color:[.2,.2,.2];this.A.ambientColor=h,o&&i.Util.extend(this.A,o)}else{const s=n.reshader.pbr.PBRUtils.getPBRUniforms(e,null,r,t&&t.ssr,t&&t.jitter);i.Util.extend(this.A,s)}}I(t,e){const n=["webgl","experimental-webgl"];let s=null;for(let i=0;i<n.length;++i){try{s=t.getContext(n[i],e)}catch(t){}if(s)break}return s}H(t,e,n={}){if(!this.B||!this.layer.isVisible())return null;const s=this.layer.getMap(),r=this.canvas.gl&&this.canvas.gl.wrap;if(this.T||r){if(!this.l||!Object.keys(this.l).length)return null;const t=this.J(),e=i.Util.extend({},this.A);e.pointSize=this.layer.options.pointSize||1,this.B.render(t,e,!0),this.T=!1}const{meshId:o,pickingId:a,point:h}=this.B.pick(t,e,n.tolerance||3,{"projViewMatrix":s.projViewMatrix,"pointSize":this.layer.options.pointSize||1},{viewMatrix:s.viewMatrix,projMatrix:s.projMatrix,returnPoint:!0}),u=this.K(a);return{meshId:o,target:this.layer.$()[u],pickingId:a,point:h,index:a-u}}K(t){if(!h(t))return null;if(this.layer.$()[t])return t;const e=Object.keys(this.layer.$()).sort().map((t=>Number(t))),n=e.length;let s=0,i=n-1,r=Math.floor((s+i)/2);for(;s<=n-1&&i>=0;){if(s===i)return e[s];if(e[r]<=t&&t<e[r+1])return e[r];t<e[r]?(i=r-1,r=Math.floor((s+i)/2)):e[r+1]<t&&(s=r+1,r=Math.floor((s+i)/2))}return null}isInFrustum(t){const e=this.layer.getMap(),s=t.Y;if(!s||"multigltfmarker"===t.getGLTFMarkerType())return!0;const i=n.vec2.set(T,s.min,s.max);return!!p(e.projViewMatrix,i)}getRenderMeshesTest(){return this.J()}isMarkerTransparent(t){return t.W()}getMarkerFitSizeScale(t){return t.Z()}getMarkerFitTranslate(t){return t.tt()}getFBORayPicking(){return this.B}getShaderList(){return this.i}}let A;const E={width:100,height:10};function I(){if(!A){const{width:t,height:e}=E;OffscreenCanvas?A=new OffscreenCanvas(t,e):(A=document.createElement("canvas"),A.width=t,A.height=e)}return A}class P{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,s=-1/0;for(let e=0,i=t.length;e<i;e++){const i=t[e][0];n=Math.min(i,n),s=Math.max(i,s)}this.min=n,this.max=s,this.valueOffset=this.max-this.min,this.options=Object.assign({},E,e),this.et()}getImageData(){return this.imgData}et(){const t=I(),{width:e,height:n}=this.options;t.width=e,t.height=n;const s=t.getContext("2d");s.clearRect(0,0,t.width,t.height);const i=s.createLinearGradient(0,0,t.width,0),{colors:r,valueOffset:o}=this;for(let t=0,e=r.length;t<e;t++){const[e,n]=r[t],s=(e-this.min)/o;i.addColorStop(s,n)}s.fillStyle=i,s.fillRect(0,0,t.width,t.height),this.imgData=s.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const s=4*n;return[this.imgData.data[s],this.imgData.data[s+1],this.imgData.data[s+2],this.imgData.data[s+3]]}}var k;function N(t,e){var n,s,i;if(V(t)){var r,o=t.stops&&"object"==typeof t.stops[0][0],a=o||void 0!==t.property,h=o||!a,u=t.type||e||"exponential";if("exponential"===u)r=R;else if("interval"===u)r=L;else if("categorical"===u)r=C;else if("identity"===u)r=U;else{if("color-interpolate"!==u)throw new Error('Unknown function type "'+u+'"');r=F}if(o){var c={},l=[];for(let e=0;e<t.stops.length;e++){var f=t.stops[e];void 0===c[f[0].zoom]&&(c[f[0].zoom]={zoom:f[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),c[f[0].zoom].stops.push([f[0].value,f[1]])}for(let t in c)l.push([c[t].zoom,N(c[t])]);n=function(e,n){const s=R({stops:l,base:t.base},e)(e,n);return"function"==typeof s?s(e,n):s},s=!1,i=!1}else h?(n=function(e){const n=r(t,e);return"function"==typeof n?n(e):n},s=!0,i=!1):(n=function(e,n){const s=r(t,n?n[t.property]:null);return"function"==typeof s?s(e,n):s},s=!1,i=!0)}else n=function(){return t},s=!0,i=!0;return n.isZoomConstant=i,n.isFeatureConstant=s,n}function C(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function L(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function R(t,e){for(var n=void 0!==t.base?t.base:1,s=0;!(s>=t.stops.length||e<=t.stops[s][0]);)s++;return 0===s?t.stops[s][1]:s===t.stops.length?t.stops[s-1][1]:j(e,n,t.stops[s-1][0],t.stops[s][0],t.stops[s-1][1],t.stops[s][1])}"function"==typeof Map&&(k=new Map);const B={width:100,height:1};function F(t,e){const n=t.stops;if(n&&n.length>1){let t;if(k){const e=JSON.stringify(n);if(!k.has(e)){const t=new P(n,B);k.set(e,t)}t=k.get(e)}else t=new P(n,B);const[s,i,r,o]=t.getColor(e);return[s/255,i/255,r/255,o/255]}return n&&1===n.length?n[0][1]:null}function U(t,e){return n=e,s=t.default,void 0!==n?n:void 0!==s?s:void 0!==i?i:null;var n,s,i}function j(t,e,n,s,i,r){return"function"==typeof i?function(){var o=i.apply(void 0,arguments),a=r.apply(void 0,arguments);return j(t,e,n,s,o,a)}:i.length?function(t,e,n,s,i,r){var o=[];for(let a=0;a<i.length;a++)o[a]=D(t,e,n,s,i[a],r[a]);return o}(t,e,n,s,i,r):D(t,e,n,s,i,r)}function D(t,e,n,s,i,r){var o,a=s-n,h=t-n;return i*(1-(o=1===e?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1)))+r*o}function V(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function q(t){for(const e in t)if(V(t[e]))return!0;return!1}function G(t){return J(t,"exponential")}function z(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var s,i=[];for(let r=0;r<t.length;r++)s=z(t[r],e),s?(i.push(s),n=!0):i.push(t[r]);return n?i:t}var r,o={"__fn_types_loaded":!0},a=[];for(r in t)t.hasOwnProperty(r)&&a.push(r);const h=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=G(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let e=0,s=a.length;e<s;e++)r=a[e],V(t[r])?(n=!0,o["_"+r]=t[r],h(r)):o[r]=t[r];return n?o:t}function J(t,e){if(!V(t))return function(){return t};let n=!0,s=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let t=0;t<i.length;t++)if(V(i[t][1])){const r=J(i[t][1],e);n=n&&r.isZoomConstant,s=s&&r.isFeatureConstant,i[t]=[i[t][0],r]}const r=N(t,e);return r.isZoomConstant=n&&r.isZoomConstant,r.isFeatureConstant=s&&r.isFeatureConstant,r}const X=[],H=[],K=[],$=[],Y=[],W=[1,1,1],Z=[],Q=[1,1,1],tt=function(t,e){const n=[];return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=0,n[4]=t[3],n[5]=t[4],n[6]=t[5],n[7]=0,n[8]=t[6],n[9]=t[7],n[10]=t[8],n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}(function(t){const e=Math.cos(t),n=Math.sin(t),s=[];return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=e,s[5]=n,s[6]=0,s[7]=-n,s[8]=e,s}(.5*Math.PI),[0,0,0]),et=[186/255,186/255,186/255,1],nt={"lightAmbient":[1,1,1],"lightDiffuse":[1,1,1],"lightSpecular":[1,1,1],"lightDirection":[1,1,1]};class st extends e.Marker{constructor(t,s){const i=e.Util.extend({},s),r=i.symbol;super(t,i),this.options.symbol=r,this.nt=!1,this.st=n.mat4.identity([]),this.it="gltfmarker",this.rt=!0,this.ot={get translation(){return[0,0,0]},get rotation(){return[0,0,0]},get scale(){return[1,1,1]}},this.ht()}static parseJSONData(t){const e=st.fromJSON(t);return e.setZoomOnAdded(t.zoomOnAdded),e}static fromJSON(t){return new st(t.coordinates,t.options)}getMeshes(t,e,s){let i=[];const r=this.getMap();if(this.getLayer().isVisible()&&this.isVisible()&&this.q()){if(!this.G)return this.ut(t,e),i;this.ct(this.G,s),i=this.G.filter((t=>!!(p(r.projViewMatrix,t.getBoundingBox())||t instanceof n.reshader.InstancedMesh)&&(this.lt(t),this.ft(t),!0))),this.rt=!1}return i}dt(){return this.gt}bt(t){this.gt=t}yt(t,e){this._externSymbol=this._externSymbol||{},this._externSymbol[t]=e,"uniforms"===t&&(this._t=!0)}setUrl(t){return super.updateSymbol({url:t}),this.vt=!0,this}setSymbol(t){const e=this.getUrl(),n=this.getShader();super.setSymbol(t);const s=this.M;s&&t.url!==e&&(s.logoutGLTF(e),this.xt=!1,this.wt(!1),delete this.G),t.shader!==n&&this.Tt(s,this.regl),this._t=!0,this.rt=!0}getCenter(){const t=this.getMap();if(!t)return null;const n=c(t,super.getCenter()||this.getCoordinates());if(!n)return null;const s=this.Ot(),i=new e.Point([n[0]+s[0],n[1]+s[1]]);return t.pointAtResToCoord(i,t.getGLRes())}getPointZ(){const t=this.getCoordinates(),e=this.getMap();if(!e||!t)return null;return e.altitudeToPoint(t.z||0,e.getGLRes())}getUrl(){const t=this._getInternalSymbol();return t&&t.url||"pyramid"}addTo(t){if(this.getLayer())throw new Error("GLTFMarker cannot be added to two or more layers at the same time.");return t.addGeometry(this),this}ut(t,e){const n=this.getUrl();this.M=t,this.xt||(t.loginGLTF(n),this.xt=!0);const s=t.getGLTF(n);s&&!s.then&&(this.wt(!0),this.St(s,t,e))}lt(t,e){"effectmarker"===this.getGLTFMarkerType()?this.updateUV(e):"glowmarker"===this.getGLTFMarkerType()&&this.Mt();const n=this.getUniforms();if(n&&this.isDirty()&&this.At())for(const e in n)t.material.set(e,n[e]);this.W()&&(t.transparent=!0),t.bloom=+!!this.isBloom(),"wireframe"===this.getShader()&&n&&n.dashAnimate&&t.material.set("time",e/1e3),t.setUniform("uPickingId",this.Et()),t.properties.isAnimated=this.isAnimated(),this.It(t)}ft(t){const s=this.getShader(),i=t.getDefines();if("pbr"===s){const t=this.getLayer(),{iblTexes:e}=n.reshader.pbr.PBRUtils.getIBLResOnCanvas(t.getRenderer().canvas);e?i.HAS_IBL_LIGHTING=1:delete i.HAS_IBL_LIGHTING}const r=this.getLayer().getRenderer();if(r){const t=r.getMaskUniforms();if(t&&Object.keys(t).length>0){const t=r.getMaskDefines();e.Util.extend(i,t)}else delete i.HAS_MASK_EXTENT}t.setDefines(i)}Tt(t,e){const n=this.getShader(),s=this.getUrl(),i=this.G;if(!t||!i)return;if(this.regl=e,t.isSimpleModel(s))return"wireframe"===n&&i.forEach((t=>{this.Pt(t.properties.geometryResource,e),this.lt(t)})),void this.kt(i);const r=t.getGLTF(s);r&&("wireframe"===n&&r.resources.forEach((t=>{this.Pt(t,e)})),i.forEach((t=>{this.lt(t)})),this.kt(i))}kt(t){const e=this.getShader();t.forEach((t=>{const n=this.Nt(t.properties.geometryResource);t.geometry="wireframe"===e?t.properties.geometryResource.copyGeometry:t.properties.geometryResource.geometry,t.material=n}))}Pt(t,e){t.copyGeometry.data.aBarycentric||(t.copyGeometry.buildUniqueVertex(),t.copyGeometry.createBarycentric("aBarycentric"),e?t.copyGeometry.generateBuffers(e):(this.C=this.C||[],this.C.push(t.copyGeometry)))}ct(t,e){const s=[],i=[],r=this.isAnimated();this.ht();const o=this.getModelMatrix();n.mat4.multiply(o,o,tt);const{nodeMatrixMap:a,skinMap:h}=this.Ct(e),u=this.getMap(),c=this.Lt(W),l=this.Z()||Q;n.vec3.multiply(s,l,c);if("gltf"===this.getLayer().getGltfCoordinateSystem()){const t=u.distanceToPointAtRes(1,0,u.getGLRes());n.vec3.scale(s,s,t.x)}t.forEach((t=>{const e=t.properties.geometryResource.nodeIndex,u=a[e],c=r&&u?u:t.nodeMatrix;if(t instanceof n.reshader.InstancedMesh){n.mat4.scale(i,o,s);const e=n.mat4.multiply(t.positionMatrix,i,c);t.positionMatrix=e,t.localTransform=this.Rt()}else{n.mat4.scale(i,o,s);const e=n.mat4.multiply(t.localTransform,i,c);t.localTransform=e}if(r){const n=h[e];n&&(t.material.set("skinAnimation",1),t.material.set("jointTextureSize",n.jointTextureSize),t.material.set("numJoints",n.numJoints),t.material.set("jointTexture",n.jointTexture));const s=t.geometry.properties.morphWeights;s&&this.Bt(s,t.material)}else t.material.set("skinAnimation",0)})),this.Ft(t)}Ct(t){const e=this.isAnimated(),n=this.Ut(),s={},i=this.jt();if(t&&e&&this.gltfPack&&n){const e=this.Dt();if(h(e)){this.Vt(t);const n=this.qt(),r=this.isAnimationLooped(),o=this.getAnimationSpeed();this.gltfPack.updateAnimation(t,r,o,e,n,s,i)}else console.warn("animation specified does not exist!")}return{nodeMatrixMap:s,skinMap:i}}Lt(t){const s=this.getMap();t[0]=t[1]=t[2]=1;const i=this.getSymbol(),r=i&&i.fixSizeOnZoom;if(e.Util.isNumber(r))if(r>=0){let e=s.getGLScale()/s.getGLScale(r);e*=this.Gt(),n.vec3.set(t,e,e,e),this.zt(e)}else{const e=this.Jt();n.vec3.set(t,e,e,e),this.Xt(e)}return t}Ft(t){const e=this.Ht(t);if(!e)return;const s=this.Kt(this.tt()||[],e);t.forEach((t=>{t instanceof n.reshader.InstancedMesh?(t.positionMatrix[12]+=s[0],t.positionMatrix[13]+=s[1],t.positionMatrix[14]+=s[2],this.$t(t)):(t.localTransform[12]+=s[0],t.localTransform[13]+=s[1],t.localTransform[14]+=s[2])}))}St(t,e,n){const s=this.Et(),i=this.getLayer();if(!i)return;if(!i.$()[s])return;const r=this.getUrl();this.bt(t.json),i.Yt[r]=1,this.Wt(r,e,n),this.Tt(e,n),this.wt(!0),this.fire("load",{data:t.json}),this.fire("setUrl-debug"),i.getRenderer().setToRedraw(),i.Zt()&&i.fire("modelload",{models:i.getGLTFUrls()})}Wt(t,e,n){const s=[],i=this.getShader(),r=this.getLayer(),o=e.getGLTF(t);if(o&&o.resources){if(!o.resources.length){const e="there are no geomtries in the gltf model";return console.error(e),void r.fire("modelerror",{type:"modelerror",url:t,info:e})}this.gltfPack=o.gltfPack,o.resources.forEach((t=>{const e=this.Qt(t,i,n);s.push(e)}))}this.G&&this.te(),this.G=s,this.Z()?this.Z()&&(this.ee([1,1,1]),this.ne([0,0,0]),this.se(this.G)):this.se(this.G),this.fire("createscene-debug",{meshes:this.G})}te(){const t=this.Ht(this.G);this.Y=t;const e=n.vec3.subtract(H,t.max,t.min);n.vec3.divide(e,e,this.getScale());const s=Math.max(...e)/this.getMap().getGLScale(this.getZoomOnAdded());this.ie(s)}se(t){this.ct(t);let e=this.Ht(t);if(!e)return;const n=this.re(this.Z()||[],e);this.oe=n,this.ct(t),e=this.Ht(t),e&&(this.Kt(this.tt()||[],e),this.Y=e)}re(t,e){let s=1;if("map"===this.getLayer().getGltfCoordinateSystem()){const i=n.vec3.subtract(t,e.max,e.min),r=Math.max(...i);let o=null;o=this.Z()&&this.ae()?this.ae():this.he();const a=function(t,e,n){return e*t.getGLScale(n)}(this.getMap(),o,this.getZoomOnAdded());s=a/r}const i=n.vec3.set(t,s,s,s);return n.vec3.multiply(t,this.getScale(),i)}Kt(t,e){if("map"===this.getLayer().getGltfCoordinateSystem()){const s=this.getPointZ()||0;if("multigltfmarker"===this.getGLTFMarkerType())return n.vec3.set(t,0,0,-e.min[2]+s);if(!this.ue()){const t=this.tt();return n.vec3.set(Z,0,0,s),n.vec3.add(Z,Z,t)}const i=this.getAnchorZ()||"bottom";let r=0;"bottom"===i?r=-e.min[2]:"top"===i?r=-e.max[2]:"center"===i&&(r=-(e.min[2]+e.max[2])/2);const o=this.getModelMatrix(),a=this.Ot();n.vec3.set(t,-(e.min[0]+e.max[0])/2+o[12],-(e.min[1]+e.max[1])/2+o[13],r+a[2]),this.vt=!1,this.ne(t);const h=n.vec3.copy(Z,t);return h[2]+=s,h}return t[0]=t[1]=t[2]=0,this.ne(t),t}Ht(t){if(!t||!t.length)return null;if(!this.ue())return this.Y;"multigltfmarker"===this.getGLTFMarkerType()&&t.forEach((t=>{const e=this.ce();for(const n in e)t.updateInstancedData(n,e[n]);t.updateBoundingBox()}));const e=t[0].getBoundingBox(),s=n.vec3.copy([],e[0]),i=n.vec3.copy([],e[1]);for(let e=1;e<t.length;e++){const r=t[e].getBoundingBox(),o=n.vec3.copy([],r[0]),a=n.vec3.copy([],r[1]);o[0]<s[0]&&(s[0]=o[0]),o[1]<s[1]&&(s[1]=o[1]),o[2]<s[2]&&(s[2]=o[2]),a[0]>i[0]&&(i[0]=a[0]),a[1]>i[1]&&(i[1]=a[1]),a[2]>i[2]&&(i[2]=a[2])}return{min:s,max:i}}ue(){if(!this.Y)return!0;const t=this.getSymbol(),e=t&&t.fixSizeOnZoom;if(this.vt)return!0;const n=this.getLayer().getMap();return!(e>0&&!n.isZooming())}Qt(t,e,s){const i=t;i.copy(),"wireframe"===e&&i.createCopyBarycentric();const r=this.le(i,e,s),o=r.getDefines();return r instanceof n.reshader.InstancedMesh?(o.HAS_PICKING_ID=1,o.HAS_INSTANCE_COLOR=1):o.HAS_PICKING_ID=2,r.geometry.data.COLOR_0&&(o.HAS_COLOR0=1),i.extraInfo&&"MASK"===i.extraInfo.alphaMode&&(o.HAS_ALPHAMODE=1),r.setDefines(o),r}le(t,e,s){const i=this.getGLTFMarkerType();let r=null;const o=this.Nt(t),a="wireframe"===e?t.copyGeometry:t.geometry;if(s?a.generateBuffers(s):(this.C=this.C||[],this.C.push(a)),"multigltfmarker"===i){this.fe();const t=this.ce(n.mat4.identity(Y)),e=this.getCount();r=new n.reshader.InstancedMesh(t,e,a,o),r.setUniform("instance",1),s?r.generateInstancedBuffers(s):(this.N=this.N||[],this.N.push(r))}else r=new n.reshader.Mesh(a,o),r.setUniform("instance",0);r.nodeMatrix=n.mat4.copy([],t.nodeMatrix),r.properties.geometryResource=t,this.isBloom()&&(r.bloom=1),r.transparent=this.W();const h=t.extraInfo;return"BLEND"!==h.alphaMode&&"MASK"!==h.alphaMode||(r.transparent=!0),r.properties.pickingId=this.Et(),this.It(r),r}Nt(t){let e=null;const s=this.getShader(),i=this.getUniforms()||{},r=t.materialInfo||{},o=this.getLayer().getRenderer();if("phong"===s)if("pbrSpecularGlossiness"===r.name)e=new n.reshader.PhongSpecularGlossinessMaterial(r);else{for(const t in nt)i[t]=i[t]||nt[t];e=new n.reshader.PhongMaterial(r)}else if("wireframe"===s)e=new n.reshader.WireFrameMaterial(r);else if("pbr"===s){if(e="pbrSpecularGlossiness"===r.name?new n.reshader.pbr.StandardSpecularGlossinessMaterial(r):new n.reshader.pbr.StandardMaterial(r),o.regl&&!n.reshader.pbr.PBRUtils.isSupported(o.regl)){e=n.reshader.PhongMaterial.convertFrom(e);for(const t in nt)i[t]=i[t]||nt[t]}}else e=new n.reshader.Material(r);e.doubleSided=t.extraInfo&&t.extraInfo.doubleSided?1:0;for(const t in i)e.set(t,i[t]);return t.morphWeights&&this.Bt(t.morphWeights,e),t.skin&&e.set("skinAnimation",0),e}Bt(t,e){const n=e.get("morphWeights1")||[],s=e.get("morphWeights2")||[];for(let e=0;e<4;e++)n[e]=t[e]||0,s[e]=t[e+4]||0;e.set("morphWeights1",n),e.set("morphWeights2",s)}It(t){const e=this.getSymbol();e&&e.uniforms?(t.setUniform("polygonFill",e.uniforms.polygonFill||et),t.setUniform("polygonOpacity",void 0===e.uniforms.polygonOpacity?1:e.uniforms.polygonOpacity),t.setUniform("lineColor",e.uniforms.lineColor||et),t.setUniform("lineOpacity",void 0===e.uniforms.lineOpacity?1:e.uniforms.lineOpacity)):(t.setUniform("polygonFill",et),t.setUniform("polygonOpacity",1),t.setUniform("lineColor",et),t.setUniform("lineOpacity",1))}de(){const t=this.getLayer();if(!t)return;const s=t.getMap();if(!s)throw Error("marker has not been added to map");const i=this.G,r=this.Ht(i);if(!r)return null;const o=this.getPointZ()||0,a=r.min,h=r.max,u=n.vec4.set(K,a[0],a[1],a[2],1),c=n.vec4.set($,h[0],h[1],h[2]+o,1),l=n.vec4.transformMat4(u,u,s.projViewMatrix),f=n.vec4.transformMat4(c,c,s.projViewMatrix),d=(l[0]/l[3]+1)*s.width/2,m=(1-l[1]/l[3])*s.height/2,p=(f[0]/l[3]+1)*s.width/2,g=(1-f[1]/l[3])*s.height/2,b=Math.min(d,p),y=Math.max(d,p),_=Math.min(m,g),v=Math.max(m,g);return new e.Extent({xmin:b,xmax:y,ymin:_,ymax:v})}onAdd(){const t=this.getLayer().getMap();if(t&&!h(this.me)){const e=t.getZoom();this.me=e}}onRemove(){this.pe()}remove(){const t=this.getUrl();this.M&&(delete this.G,this.M.logoutGLTF(t),delete this.M),delete this.gt,delete this.gltfPack,super.remove()}show(){return super.updateSymbol({visible:!0}),this}hide(){super.updateSymbol({visible:!1})}setBloom(t){return super.updateSymbol({bloom:t}),this}isBloom(){const t=this._getInternalSymbol();return t&&t.bloom}setCastShadow(t){return super.updateSymbol({shadow:t}),this}isCastShadow(){const t=this._getInternalSymbol();return t&&t.shadow}outline(){return this.ge=!0,this.rt=!0,this}cancelOutline(){return this.ge=!1,this.rt=!0,this}isOutline(){return this.ge}isVisible(){const t=this._getInternalSymbol();return!t||!h(t.visible)||t.visible}setCoordinates(t){return super.setCoordinates(t),this.ot&&this.ht(),this.rt=!0,this}copy(){const t=this.toJSON(),e=st.fromJSON(t);return e.setZoomOnAdded(this.me),e}setShader(t){return super.updateSymbol({shader:t}),this}getShader(){const t=this._getInternalSymbol();return t&&t.shader||"pbr"}setUniforms(t){return super.updateSymbol({uniforms:t}),this._t=!0,this}getUniforms(){const t=this._getInternalSymbol();return t&&t.uniforms}setUniform(t,e){const n=this.getUniforms()||{};return n[t]=e,super.updateSymbol({uniforms:n}),this._t=!0,this}getUniform(t){const e=this._getInternalSymbol();return e&&e.uniforms&&e.uniforms[t]}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation&&this.gt&&this.gt.animations}isDashAnimated(){const t=this._getInternalSymbol();return t&&t.uniforms&&t.uniforms.dashEnabled&&t.uniforms.dashAnimate}setAnimation(t){return super.updateSymbol({animation:t}),delete this.be,this}setAnimationLoop(t){return super.updateSymbol({loop:t}),delete this.be,this.rt=!0,this}isAnimationLooped(){const t=this._getInternalSymbol();return t&&t.loop}getAnimationSpeed(){const t=this._getInternalSymbol();return t&&h(t.speed)?t.speed:1}setAnimationSpeed(t){return super.updateSymbol({speed:t}),this}ye(t){const e=this.getMap();return e?c(e,t||this.getCoordinates()):null}setTRS(t,e,n){const s=t||this.ot.translation;return super.updateSymbol({translationX:s[0],translationY:s[1],translationZ:s[2],rotationX:e[0],rotationY:e[1],rotationZ:e[2],scaleX:n[0],scaleY:n[1],scaleZ:n[2]}),this.ht(),this._e=!0,this}ve(){const t=this.Ot(),e=this.ye();return e?n.vec3.add(t,t,e):t}setTranslation(t,e,n){return super.updateSymbol({translationX:t,translationY:e,translationZ:n}),this.ht(),this}setRotation(t,e,n){return super.updateSymbol({rotationX:t,rotationY:e,rotationZ:n}),this.ht(),this}setScale(t,e,n){return super.updateSymbol({scaleX:t,scaleY:e,scaleZ:n}),this.ht(),this.vt=!0,this}getTranslation(){const t=this._getInternalSymbol(),e=t&&t.translationX||0,s=t&&t.translationY||0,i=t&&t.translationZ||0;return n.vec3.set(this.ot.translation,e,s,i)}Ot(){const t=this.getTranslation(),e=this.getMap();if(!e)return this.ot.translation;const s=e.distanceToPointAtRes(t[0],t[1],e.getGLRes()),i=e.altitudeToPoint(t[2],e.getGLRes());return n.vec3.set([],l(s.x,t[0]),l(s.y,t[1]),l(i,t[2]))}getRotation(){const t=this._getInternalSymbol(),e=t&&t.rotationX||0,s=t&&t.rotationY||0,i=t&&t.rotationZ||0;return n.vec3.set(this.ot.rotation,e,s,i)}getScale(){const t=this._getInternalSymbol(),e=t&&t.scaleX||1,s=t&&t.scaleY||1,i=t&&t.scaleZ||1;return n.vec3.set(this.ot.scale,e,s,i)}setFixSizeOnZoom(t){return super.updateSymbol({fixSizeOnZoom:t}),this}getFixSizeOnZoom(){const t=this._getInternalSymbol();return t&&t.fixSizeOnZoom}cancelFixSize(){return this.setFixSizeOnZoom(-1)}setAnchorZ(t){return super.updateSymbol({anchorZ:t}),this}getAnchorZ(){const t=this._getInternalSymbol();return t&&t.anchorZ||"bottom"}_setExternSymbol(t){return this.rt=!0,super._setExternSymbol(t)}xe(t){return z(t,(()=>{const t=this.getMap();if(t){return[t.getZoom()]}return null}))}_prepareSymbol(t){super._prepareSymbol(t);const e=this.xe(t);return e&&e.uniforms&&(e.uniforms=this.xe(t.uniforms)),delete this.we,e}hasFunctionDefinition(){if(h(this.we))return this.we;const t=this._getInternalSymbol();return this.we=q(t)||t&&t.uniforms&&q(t.uniforms),this.we}onSymbolChanged(){super.onSymbolChanged(),this.ot&&this.ht()}setModelMatrix(t){const e=n.mat4.getTranslation(this.ot.translation,t),s=n.mat4.getRotation(this.ot.rotation,t),i=n.mat4.getScaling(this.ot.scale,t);return this.setTranslation(e[0],e[1],e[2]),this.setRotation(s[0],s[1],s[2]),this.setScale(i[0],i[1],i[2]),this}getModelMatrix(){return this.st}ht(){const t=this.ve(),e=this.getRotation(),s=n.quat.fromEuler(X,e[0],e[1],e[2]),i=this.getScale();this.st=n.mat4.fromRotationTranslationScale(this.st,s,t,i)}isDirty(){return this.rt}Te(t){return this.rt=t,this}on(t,e,n){super.on(t,e,n||this),this.getLayer()&&this.getLayer().Oe(t)}off(t,e,n){super.off(t,e,n||this),this.getLayer()&&this.getLayer().Se()}Me(){const t=this.toJSON();return t.zoomOnAdded=this.me,t}toJSON(){const t=JSON.parse(JSON.stringify({coordinates:this.getCoordinates(),options:this.options||{}})),n=this.getId();e.Util.isNil(n)||(t.options.id=n);const s=this.getProperties();s&&(t.options.properties=JSON.parse(JSON.stringify(s)));const i=this.getSymbol();return i&&(t.options.symbol=JSON.parse(JSON.stringify(i))),t}setZoomOnAdded(t){this.me=t}getZoomOnAdded(){return this.me}W(){return this.q()<1}q(){const t=this.getUniforms(),e=this.getShader();return"phong"===e||"wireframe"===e?t&&h(t.opacity)?t.opacity:1:"pbr"===e&&t&&h(t.polygonOpacity)?t.polygonOpacity:1}wt(t){this.nt=t}isLoaded(){return this.nt}getGLTFMarkerType(){return this.it}Ae(t){this.Ee=t}Et(){return this.Ee}getCount(){return 1}ee(t){this.oe=t}Z(){return this.oe}ne(t){this.Ie=t}tt(){return this.Ie}getContainerExtent(){return this.de()}getGLTFAsset(){return this.gt&&this.gt.asset}openInfoWindow(){this.gt?super.openInfoWindow():this.once("load",(()=>{super.openInfoWindow()}))}getAnimations(){if(!this.gt)return null;const t=this.gt.animations;return t?t.map(((t,e)=>t.name||e)):null}getCurrentAnimation(){const t=this._getInternalSymbol();return t&&t.animationName}Dt(){const t=this.getAnimations();if(!t)return null;const e=this.getCurrentAnimation();return h(e)?t.indexOf(e)>-1?e:void 0:t[0]}setCurrentAnimation(t){this.updateSymbol({animationName:t})}Vt(t){h(this.be)||(this.be=t)}qt(){return this.be||0}jt(){this.Pe=this.Pe||{};for(const t in this.Pe)this.Pe[t].jointTexture.destroy(),delete this.Pe[t];return this.Pe}zt(t){this.ke=t}Jt(){return this.ke||1}Xt(t){this.Ne=t}Gt(){return this.Ne||1}ie(t){this.Ce=t}ae(){return this.Ce}Le(){return this._e}Re(){this._e=!1}At(){return this._t}Be(){this._t=!1}setAnimationTimeframe(t){const e=this.qt(),n=this.jt();this.gltfPack.updateAnimation(t,this.isAnimationLooped(),this.getAnimationSpeed(),e,{},n)}he(){return this.options.fitSize||100}pe(){delete this.Y,delete this.Fe,delete this.me,delete this.oe,delete this.Ie,delete this.ke,delete this.Ne,delete this.Ce}Ut(){return"effectmarker"!==this.getGLTFMarkerType()&&"glowmarker"!==this.getGLTFMarkerType()}}st.mergeOptions({symbol:null}),st.registerJSONType("GLTFMarker");
/*!
       Feature Filter by

       (c) mapbox 2016 and maptalks 2018
       www.mapbox.com | www.maptalks.org
       License: MIT, header required.
   */
const it=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function rt(t){return new Function("f",`var p = (f && f.properties || {}); return ${ot(t)}`)}function ot(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";return`(${"=="===e?ht(t[1],t[2],"===",!1):"!="===e?ht(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?ht(t[1],t[2],e,!0):"any"===e?ut(t.slice(1),"||"):"all"===e?ut(t.slice(1),"&&"):"none"===e?ft(ut(t.slice(1),"||")):"in"===e?ct(t[1],t.slice(2)):"!in"===e?ft(ct(t[1],t.slice(2))):"has"===e?lt(t[1]):"!has"===e?ft(lt(t[1])):"true"})`}function at(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function ht(t,e,n,s){const i=at(t),r="$type"===t?it.indexOf(e):JSON.stringify(e);return(s?`typeof ${i}=== typeof ${r}&&`:"")+i+n+r}function ut(t,e){return t.map(ot).join(e)}function ct(t,e){"$type"===t&&(e=e.map((t=>it.indexOf(t))));const n=JSON.stringify(e.sort(dt)),s=at(t);return e.length<=200?`${n}.indexOf(${s}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${s}, ${n},0,${e.length-1})`}function lt(t){return"$id"===t?'"id" in f':`${JSON.stringify(t)} in p`}function ft(t){return`!(${t})`}function dt(t,e){return t<e?-1:t>e?1:0}function mt(t){if(!Array.isArray(t))return mt([t]);const e=[];for(let n=0;n<t.length;n++){let s;s=!0===t[n].filter?function(){return!0}:rt(t[n].filter),e.push(pt({},t[n],{filter:s}))}return e}function pt(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}const gt=/\{ *([\w_]+) *\}/g;class bt extends st{constructor(t,e){super(t,e),this.it="effectmarker"}static fromJSON(t){return new bt(t.coordinates,t.options)}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}setTexture(t){const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const n=this.getTextureUrl();e.Ue(n),e.je(t)}return super.updateSymbol({textureUrl:t}),this}De(t){const e=this.getTextureUrl(),n=this.getLayer()&&this.getLayer().getRenderer();if(n){let s=e;const i=this.Ve();if(i){const n=this.isAnimationLooped(),r=this.getAnimationSpeed()||1,o=n?Math.floor(.01*t*r)%i.length:Math.floor(.01*t);s=e.replace(gt,i[o]),this.setUniform("width",1),this.setUniform("height",1),this.setUniform("uvOffset",[0,0])}return n.qe(s,this.Et())}return null}Ve(){const t=this._getInternalSymbol();return t&&t.textureNames}getTextureUrl(){const t=this._getInternalSymbol();return t&&t.textureUrl||"default"}getUrl(){return"plane"}getShader(){return"effect"}setTransparent(t){return this.options.symbol.transparent=t,this}isTransparent(){return this.options.symbol.transparent}updateUV(t){const e=this.isAnimationLooped(),n=this.getAnimationSpeed()||1,s=this.getUniforms()||{},i=s.width||1,r=s.height||1;let o;const a=this.getEffectType();"uv"===a?o=e?.01*t*n%(i*r):.01*t:"sequence"===a&&(o=e?Math.floor(.01*t*n)%(i*r):Math.floor(.01*t));const h=Number(o%i),u=Math.floor(o/i),c=this.De(t);this._getSymbol()?(this.setUniform("uvOffset",[h,u]),this.setUniform("width",i),this.setUniform("height",r),this.setUniform("texture",c)):this.yt("uniforms",{uvOffset:[h,u],width:i,height:r,texture:c})}_setExternSymbol(t){super._setExternSymbol(t);const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const t=this.getTextureUrl();e.je(t)}}getEffectType(){const t=this._getInternalSymbol();return t&&t.effect||"uv"}setEffectType(t){return this._getInternalSymbol().effect=t,this}remove(){const t=this.getLayer()&&this.getLayer().getRenderer();if(t){const e=this.getTextureUrl();t.Ue(e)}super.remove()}}const yt=["Point","Polygon","LineString","MultiPoint","MultiPolygon","MultiLineString","GeometryCollection","Feature","FeatureCollection"].reduce(((t,e)=>(t[e]=!0,t)),{}),_t={toGeometry:function(t,n){if(e.Util.isString(t)&&(t=e.Util.parseJSON(t)),Array.isArray(t)){const s=[];for(let i=0,r=t.length;i<r;i++){const r=_t.Ge(t[i],n);Array.isArray(r)?e.Util.pushIn(s,r):s.push(r)}return s}return _t.Ge(t,n)},Ge:function(t,n){if(!t||e.Util.isNil(t.type))return null;const s=t.type;if("Feature"===s){const e=t.geometry,s=_t.Ge(e,n);return s?(s.setId(t.id),s.setProperties(t.properties),s):null}if("FeatureCollection"===s){const e=t.features;if(!e)return null;return _t.toGeometry(e,n)}if("Point"===s)return function(t,e){if("EffectLayer"===e)return new bt(t);return new st(t)}(t.coordinates,n);if("GeometryCollection"===s){const e=t.geometries,s=[],i=e.length;for(let t=0;t<i;t++)s.push(_t.Ge(e[t],n));return s}throw new Error("geometry's type is invalid, only support type of Point")},isGeoJSON:function(t){return!(!t||"object"!=typeof t)&&(!!t.type&&(!!yt[t.type]&&!(t instanceof e.Geometry)))}};const vt=["mousedown","mouseup","mousemove","contextmenu","click","dbclick","touchstart","touchmove","touchend"],xt=/\{*(\$root)*\}/g;class wt extends i.OverlayLayer{constructor(t,e,n){!e||e instanceof i.Geometry||Array.isArray(e)||yt[e.type]||(n=e,e=null),super(t,null,n),this.pickingId=0,this.ze={},this.Yt={},this.Je={},this.mapEvents="";const s=n&&n.style;this.setStyle(s),e&&this.addGeometry(e)}static registerShader(t,e,n,s){_[t]={name:t,type:e,config:n,uniforms:s}}static removeShader(t){delete _[t]}static getShaders(){const t=[];for(const e in _)t.push({shader:e,uniforms:_[e].uniforms});return t}static getShaderMap(){return _}addGeometry(t,e){let n=_t.isGeoJSON(t)?_t.toGeometry(t,this.getJSONType()):t;n=Array.isArray(n)?n:[n];for(let t=0;t<n.length;t++)if(!this.Xe(n[t]))return void console.error("type of geometry is invalid");super.addGeometry(n,e),Array.isArray(n)&&this.addMarker(n)}addMarker(t){for(let e=0;e<t.length;e++){const n=t[e];n.Ae(this.pickingId),this.ze[this.pickingId]=n,this.Oe(n.getListeningEvents());const s=n.getId();s&&(this.Je[s]=n),n.fire("add",{type:"add",target:n,layer:this}),"multigltfmarker"===n.getGLTFMarkerType()?this.pickingId+=n.getCount():this.pickingId++}}He(t){const e=this.getRenderer();e&&e.loginGLTFMarker(t)}toJSON(t){t||(t={});const e={"type":this.getJSONType(),"id":this.getId(),"options":this.config()};if((a(t.style)||t.style)&&(e.style=this.getStyle()),a(t.geometries)||t.geometries){const t=[],n=this._geoList;for(let e=0;e<n.length;e++){const s=n[e].Me();t.push(s)}e.geometries=t}return e}Xe(t){if(!t.getGLTFMarkerType)return!1;return this.options.markerTypes.indexOf(t.getGLTFMarkerType())>-1}setStyle(t){return t?(this.options.style=t,this.Ke=JSON.parse(JSON.stringify(t)),this.$e(),this.fire("setstyle",{target:this,style:this.Ke}),this):(delete this.Ke,delete this.options.style,this)}getStyle(){return this.options.style}updateSymbol(t,e){const n=this.getStyle();this.Ye(t,e,n),this.Ye(t,e,this.Ke),this.$e(),this.fire("updatesymbol",{target:this,index:t,symbol:e})}Ye(t,e,n){if(!n)return;const s=(n.style?n.style:n)[t].symbol||{};for(const t in e)s[t]=e[t]}$e(){this._processRootUrl(this.Ke);const t=this.Ke.style?this.Ke.style:this.Ke;this.We=mt(t);this._geoList.forEach((function(t){this.Ze(t)}),this)}getGLTFUrls(){return Object.keys(this.Yt)}Oe(t){const e=i.Util.isString(t)?t.split(/\s+/).map((t=>"mouseleave"===t||"mouseenter"===t||"mouseout"===t?"mousemove":t)):t;let n=this.mapEvents;const s=u(e,vt).filter((t=>this.mapEvents.indexOf(t)<0));this.mapEvents+=" "+s.join(" "),this.mapEvents=this.mapEvents.trim();const r=this.mapEvents.replace(" "," dom:");n=n.replace(" "," dom:");const o=this.getMap();o&&(o.off("dom:"+n,this.Qe,this),o.on("dom:"+r,this.Qe,this))}Se(){const t={};let e=this.mapEvents;const n=this._geoList;for(let e=0;e<n.length;e++){const s=n[e].getListeningEvents().map((t=>"mouseleave"===t||"mouseenter"===t||"mouseout"===t?"mousemove":t));for(let e=0;e<s.length;e++)t[s[e]]=1}this.mapEvents=u(Object.keys(t),vt).join(" ");const s=this.mapEvents.replace(" "," dom:");e=e.replace(" "," dom:");const i=this.getMap();i&&(i.off("dom:"+e,this.Qe,this),i.on("dom:"+s,this.Qe,this))}_processRootUrl(t){i.Util.isString(t.$root)&&t.style.forEach((e=>{const n=e.symbol.url;n&&n.indexOf("{$root}")>-1&&(e.symbol.url=n.replace(xt,t.$root))}))}Ze(t){if(!this.We)return!1;for(let e=0,n=this.We.length;e<n;e++)if(!0===this.We[e].filter({properties:t.getProperties()})){const n=this.We[e].symbol,s=n.url;return t.yt("url",s),t.updateSymbol(n),!0}return!1}tn(t){if(this.We)for(let e=0,n=this.We.length;e<n;e++)!0===this.We[e].filter({properties:t.getProperties()})&&this.We[e].outline&&t.outline()}removeGeometry(t){this.Se(),super.removeGeometry(t)}getMapEvents(){return this.mapEvents}en(t){const e=i.Util.isString(t)?this.Je[t].Et():t.Et(),n=this.getRenderer();n&&n.nn(e),delete this.ze[e],delete this.Je[t]}clear(){return super.clear(),this.ze={},this.Je={},this}$(){return this.ze}H(t,e,n){const s=this.getRenderer();return s?s.H(t,e,n):null}Zt(){const t=this._geoList;for(let e=0;e<t.length;e++)if(!t[e].isLoaded())return!1;return!0}de(t){const e=this.getRenderer();return e?e.de(t):null}Qe(t){if(!this.options.markerEvents)return;const e=this.getMap();if(!e)return;this.sn=this.rn,this.an=this.hn,this.un=this.cn,this.ln=this.dn;const n=t.containerPoint,s=Math.round(n.x),i=Math.round(n.y);if(s<=0||s>=e.width||i<=0||i>=e.height)return this.rn=null,this.cn=null,void(this.hn=null);const r=this.H(s,i);if(!r)return;r.coordinate=t.coordinate,this.rn=r.target?r.target.Et():null,this.cn=r.meshId,this.hn=JSON.stringify(r.point),this.dn=r.pickingId;const o=t.type.replace("dom:","");if("mousemove"===o){this.mn().forEach((t=>{t.target.fire(t.type,t)}))}else r.target&&r.target.fire(o,r)}mn(){const t=[];return h(this.rn)&&!h(this.sn)?t.push({type:"mouseenter",target:this.ze[this.rn],meshId:this.cn,pickingId:this.dn,point:JSON.parse(this.hn)}):!h(this.rn)&&h(this.sn)?t.push({type:"mouseout",target:this.ze[this.sn],meshId:this.un,pickingId:this.ln,point:JSON.parse(this.an)},{type:"mouseleave",target:this.ze[this.sn],meshId:this.un,pickingId:this.ln,point:JSON.parse(this.an)}):h(this.rn)&&h(this.sn)&&(this.rn===this.sn?t.push({type:"mousemove",target:this.ze[this.rn],meshId:this.cn,pickingId:this.dn,point:JSON.parse(this.hn)}):t.push({type:"mouseenter",target:this.ze[this.rn],meshId:this.cn,pickingId:this.dn,point:JSON.parse(this.hn)},{type:"mouseout",target:this.ze[this.sn],meshId:this.un,pickingId:this.ln,point:JSON.parse(this.an)},{type:"mouseleave",target:this.ze[this.sn],meshId:this.un,pickingId:this.ln,point:JSON.parse(this.an)})),t}Tt(t){const e=this.getRenderer();e&&e.Tt(t)}outlineBatch(t){const e=this.Ke.style?this.Ke.style:this.Ke;e[t].outline=!0,this.We=mt(e);this._geoList.forEach((t=>{this.tn(t)}))}outlineAll(){this._geoList.forEach((t=>{t.outline()}))}cancelOutline(){if(this.Ke){(this.Ke.style?this.Ke.style:this.Ke).forEach((t=>{delete t.outline}))}this._geoList.forEach((t=>{t.cancelOutline()}))}setGltfCoordinateSystem(t){this.options.gltfCoordinateSystem=t}getGltfCoordinateSystem(){return this.options.gltfCoordinateSystem}}wt.mergeOptions({"renderer":"gl","doubleBuffer":!1,"glOptions":null,"markerEvents":!0,"forceRenderOnZooming":!0,"forceRenderOnMoving":!0,"forceRenderOnRotating":!0,"gltfCoordinateSystem":"map"});class Tt extends(n.MaskLayerMixin(wt)){static initDefaultShader(){const t=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new n.reshader.PhongMaterial;return{shader:t,material:e}}();Tt.registerShader("phong","PhongShader",t.shader,t.material.getUniforms());const e=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{cull:{enable:!1,face:"back"},frontFace:"cw",blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new n.reshader.WireFrameMaterial;return{shader:t,material:e}}();Tt.registerShader("wireframe","WireframeShader",e.shader,e.material.getUniforms());const s=function(){const t={positionAttribute:"POSITION",normalAttribute:"NORMAL",tangentAttribute:"TANGENT",colorAttribute:"COLOR_0",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",extraCommandProps:{cull:{enable:!0},frontFace:"ccw",blend:{enable:(t,e)=>!!e.meshConfig.transparent,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},e=new n.reshader.pbr.StandardMaterial({});return{shader:t,material:e}}();Tt.registerShader("pbr","pbr.StandardShader",s.shader,s.material.getUniforms()),Tt.registerShader("depth","pbr.StandardDepthShader",s.shader,s.material.getUniforms());const i=function(){const t={positionAttribute:"POSITION",color0Attribute:"COLOR_0",extraCommandProps:{blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},e=new n.reshader.Material;return{shader:t,material:e}}();Tt.registerShader("pointline","PointLineShader",i.shader,i.material.getUniforms())}static fromJSON(t){if(!t||"GLTFLayer"!==t.type)return null;const e=new Tt(t.id,t.options),n=t.geometries,s=[];for(let t=0;t<n.length;t++){const e=st.parseJSONData(n[t]);e&&s.push(e)}return e.addGeometry(s),t.style&&e.setStyle(t.style),e}onAdd(){const t=this.getMap();t.on(this.mapEvents,this.Qe,this);this._geoList.forEach((e=>{h(e.getZoomOnAdded())||e.setZoomOnAdded(t.getZoom())})),super.onAdd()}onRemove(){super.onRemove(),this.clear()}remove(){const t=this.getMap();if(!t)return;const e=this.mapEvents.replace(" "," dom:");t.off("dom:"+e,this.Qe,this),super.remove()}identify(t,e){const n=this.getMap();if(!n)return[];const s=n.coordinateToContainerPoint(new i.Coordinate(t));return this.identifyAtPoint(s,e)}identifyAtPoint(t,e){const n=this.getMap();if(!n)return[];const s=n.getDevicePixelRatio(),i=t.x*s,r=t.y*s,o=this.H(i,r,e);return o&&o.target?[{data:o.target,point:o.point}]:[]}pn(){this.pickingId=0;for(const t in this.ze){const e=this.ze[t],n=e.Et();delete this.ze[n],e.Ae(this.pickingId),this.ze[this.pickingId]=e;const s=e.getCount();this.pickingId+=s}}}Tt.initDefaultShader(),Tt.mergeOptions({markerTypes:["gltfmarker","multigltfmarker"],pointSize:1}),Tt.registerJSONType("GLTFLayer"),Tt.registerRenderer("gl",M);const Ot=[1,1,1,1],St=[],Mt=[],At=[1,1,1],Et=new e.Coordinate(0,0);class It extends st{constructor(t,e){super(null,e),this.gn=t,this.bn=[],this.yn=[0,0,0],this._n=n.mat4.identity([]),this.it="multigltfmarker"}static fromJSON(t){return new It(t.data,t.options)}setCoordinates(t){return Array.isArray(t[0])?this.vn=t.map((t=>new e.Coordinate(t))):this.vn=t,this.updateAllData("coordinates",this.vn),this.rt=!0,this}getCoordinates(t){if(t&&this.gn&&this.gn.length){const e=t.index;return this.gn[e].coordinates}return null}addData(t){this.gn.push(t);const e=this.getLayer();return e&&e.pn(),this.rt=!0,this}removeData(t){return this.gn.splice(t,1),this.fe&&this.bn.splice(t,1),this.rt=!0,this}getData(t){return this.gn[t]}updateData(t,e,n){return this.gn[t][e]=n,this.rt=!0,this}updateAllData(t,e){for(let n=0;n<this.gn.length;n++)this.updateData(n,t,e[n]);return this}fe(){const t=this.getMap();if(this.gn&&t){this.xn(),this.bn=this.bn||[];for(let t=0;t<this.gn.length;t++){const e=this.wn(t);this.bn[t]=e}}}getCenter(){let t=0,e=0,n=0;for(let s=0,i=this.gn.length;s<i;s++){const i=this.gn[s].coordinates;t+=i.x,e+=i.y,n++}if(0===n)return null;return Et.set(t/n,e/n)}xn(){const t=this.getMap(),e=this.getCenter();this.yn=c(t,e);const s=n.quat.fromEuler(Mt,0,0,0);n.mat4.fromRotationTranslationScale(this._n,s,this.yn,At)}wn(t){const e=this.gn[t],s=this.ye(e.coordinates);if(!s)return;const i=n.vec3.sub(St,s,this.yn),r=n.vec3.add(St,e.translation||this.ot.translation,i||this.ot.translation),o=e.rotation||this.ot.rotation,a=e.scale||this.ot.scale,h=n.quat.fromEuler(Mt,o[0]||0,o[1]||0,o[2]||0);return n.mat4.fromRotationTranslationScale(this.bn[t]||[],h,r,a)}ht(){super.ht(),this.fe()}Tn(){this.On&&this.On.instance_vectorA.length/4===this.bn.length||(this.On={"instance_vectorA":[],"instance_vectorB":[],"instance_vectorC":[],"instance_color":[],"aPickingId":[],"aOutline":[]});for(let t=0;t<this.bn.length;t++){const e=this.bn[t];this.Sn("instance_vectorA",t,e,0),this.Sn("instance_vectorB",t,e,1),this.Sn("instance_vectorC",t,e,2);const n=this.gn[t].color||Ot;this.On.instance_color[4*t]=n[0],this.On.instance_color[4*t+1]=n[1],this.On.instance_color[4*t+2]=n[2],this.On.instance_color[4*t+3]=n[3],this.On.aPickingId[t]=this.Et()+t,this.On.aOutline[t]=this.gn[t].outline?1:0}return this.On}$t(t){const e=this.ce();for(const n in e)t.updateInstancedData(n,e[n]);this.regl?t.generateInstancedBuffers(this.regl):(this.N=this.N||[],this.N.push(t)),t.instanceCount=this.getCount()}Sn(t,e,n,s){this.On[t]&&n&&(this.On[t][4*e]=n[s],this.On[t][4*e+1]=n[s+4],this.On[t][4*e+2]=n[s+8],this.On[t][4*e+3]=n[s+12])}ce(t){return!this.rt&&this.On?this.On:this.Tn(t)}Rt(){return this._n}getCount(){return this.gn.length}toJSON(){const t=JSON.parse(JSON.stringify({data:this.gn,options:this.options})),e=this.getProperties();return t.options&&(t.options.properties=e),t}getIndexByPickingId(t){return t-this.Et()}outline(t){return h(t)&&this.updateData(t,"outline",!0),this}cancelOutline(t){return h(t)&&this.updateData(t,"outline",!1),this}isOutline(){if(!this.gn||!this.gn.length)return!1;for(let t=0;t<this.gn.length;t++)if(this.gn[t].outline)return!0;return!1}}const Pt=new n.reshader.Texture2D({url:void 0,mag:"linear"});class kt extends M{constructor(t){super(t),this._textureMap={}}qe(t){return this.regl&&this._textureMap[t]?this._textureMap[t].texture.getREGLTexture(this.regl):Pt}je(t){if(this._textureMap[t])this._textureMap[t].count++;else{this.Mn=this.Mn||new n.reshader.ResourceLoader;const e="default"===t?void 0:t,s=new n.reshader.Texture2D({url:e,mag:"linear"},this.Mn);s.once("complete",(()=>{this.setToRedraw()}),this),this._textureMap[t]={count:1,texture:s}}}Ue(t){this._textureMap[t]&&(this._textureMap[t].count--,this._textureMap[t].count<1&&(this._textureMap[t].texture.dispose(),delete this._textureMap[t]))}}class Nt extends wt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new n.reshader.Material;return{shader:t,material:e}}();Nt.registerShader("effect","MeshShader",t.shader,t.material.getUniforms())}onAddGeometry(t){super.onAddGeometry(t);const e=t.getTextureUrl(),n=this.getRenderer();n?n.je(e):this.on("renderercreate",(t=>{t.renderer.je(e)}))}remove(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const n=e.getTextureUrl();t.Ue(n)})),super.remove()}clear(){const t=this.getRenderer();t&&this._geoList.forEach((e=>{const n=e.getTextureUrl();t.Ue(n)})),super.clear()}getTextureMapTest(){const t=this.getRenderer();return t?t._textureMap:null}}Nt.initDefaultShader(),Nt.mergeOptions({markerTypes:["effectmarker"]}),Nt.registerJSONType("EffectLayer"),Nt.registerRenderer("gl",kt);class Ct extends st{constructor(t,e){super(t,e),this.it="glowmarker"}static fromJSON(t){return new Ct(t.coordinates,t.options)}getUrl(){return"plane"}setSpeed(t){this.setUniform("speed",t)}getSpeed(){return this._getInternalSymbol().uniforms.speed}getShader(){return"glowmarker"}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}Mt(){let t=this._getInternalSymbol().uniforms.time||0;t+=.01,this.setUniform("time",t)}}Ct.mergeOptions({visible:!0});class Lt extends wt{static initDefaultShader(){const t=function(){const t={vert:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        attribute vec3 aPosition;\n        uniform mat4 projViewModelMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 positionMatrix;\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        #include <get_output>\n        void main(){\n            mat4 localPositionMatrix = getPositionMatrix();\n            vec4 localVertex = getPosition(aPosition);\n            vec4 position = localPositionMatrix * localVertex;\n            gl_Position = projViewModelMatrix * position;\n            vec4 worldPos = modelMatrix * position;\n            v_FragPos = worldPos.xyz;\n            v_center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n        }\n    ",frag:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        #define pi 3.14159\n        const float dotsnb = 30.0; // Number of dots\n\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        uniform float time;\n        uniform float radius;\n        uniform vec3 color;\n        uniform float speed;\n        vec3 hsb2rgb(in vec3 c)\n        {\n            vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,0.0,1.0 );\n            rgb = rgb*rgb*(4.0-2.0*rgb);\n            return c.z * mix( vec3(1.0), rgb, c.y);\n        }\n\n        void main()\n        {\n            float r = length(v_FragPos - v_center);\n            r = r*2.-1.;\n            if(r>radius) {\n                gl_FragColor = vec4(1.0,1.0,1.0, 0.0);\n            } else {\n                //vec3 color = hsb2rgb(vec3(fract(time*.1),.7,.4));\n                vec3 color = color;\n                float s = abs(sin(pow(r+5.0, 1.5)-time*speed+sin(r*0.9))*sin(r+.99));\n                color *= (abs(1./(s*10.8))-.01);\n                gl_FragColor = vec4(color, (color.x + color.y + color.z) / 1.0);\n            }\n        }\n    ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return n.mat4.multiply([],e.projViewMatrix,e.modelMatrix)}}],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]}}},e=new n.reshader.Material;return{shader:t,material:e}}();Lt.registerShader("glowmarker","MeshShader",t.shader,t.material.getUniforms())}}Lt.initDefaultShader(),Lt.mergeOptions({markerTypes:["glowmarker"]}),Lt.registerJSONType("GlowMarkerLayer"),Lt.registerRenderer("gl",M);const Rt={url:"plane",animation:!0,loop:!0,rotation:[0,0,0],translation:[0,0,30],scale:[1,1,30]},Bt={width:1,height:1,modelHeight:60,startOpacity:0,endOpacity:1};class Ft extends wt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        varying float vHeight;\n        void main()\n        {\n            vec4 worldPosition = modelMatrix * vec4(aPosition, 1.0);\n            gl_Position = projViewMatrix * worldPosition;\n            vHeight = worldPosition.z;\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n        uniform float modelHeight;\n        uniform float startOpacity;\n        uniform float endOpacity;\n        varying float vHeight;\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            float opacity = (endOpacity - startOpacity) * (1.0 - vHeight / modelHeight);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a * opacity;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new n.reshader.Material;return{shader:t,material:e}}();Ft.registerShader("effectline","MeshShader",t.shader)}}Ft.initDefaultShader(),Ft.mergeOptions({markerTypes:["effectmarker"]}),Ft.registerJSONType("EffectLineLayer"),Ft.registerRenderer("gl",kt);const Ut={offsetX:0,offsetY:0,uReflectivity:.8,opacity:.9,color:[.9,0,0,1]};class jt extends wt{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        attribute vec3 aNormal;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 normalMatrix;\n        uniform float offsetX;\n        uniform float offsetY;\n        varying vec2 uv;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            uv = vec2(aTexCoord.x + offsetX, aTexCoord.y + offsetY);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D effectTexture;\n        uniform vec3 uCameraPosition;\n        uniform mat4 viewMatrix;\n        uniform float uReflectivity;\n        uniform vec4 color;\n        uniform float opacity;\n\n        varying vec2 uv;\n\n        vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n            return normalize((vec4(dir, 0.0) * matrix).xyz);\n        }\n\n        const float GAMMA_FACTOR = 2.0;\n        vec4 GammaToLinear(in vec4 value, in float gammaFactor) {\n            return vec4(pow(value.xyz, vec3(gammaFactor)), value.w);\n        }\n\n        vec4 mixTexelToLinear(vec4 value) {\n            return GammaToLinear(value, float(GAMMA_FACTOR));\n        }\n\n        void main() {\n            vec4 texColor = texture2D(effectTexture, uv);\n            if (color.a == 0.0) {\n                discard;\n            }\n            vec4 mixColor = mixTexelToLinear(color);\n            texColor.rgb += mixColor.xyz * uReflectivity;\n            texColor.a*= opacity;\n            gl_FragColor = texColor;\n        }\n    ",uniforms:[{name:"normalMatrix",type:"function",fn:function(t,e){const s=[];return n.mat4.invert(s,e.modelMatrix),n.mat4.transpose(s,s),s}}],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new n.reshader.Material;return{shader:t,material:e}}();jt.registerShader("effectring","MeshShader",t.shader)}}jt.initDefaultShader(),jt.mergeOptions({markerTypes:["effectring"]}),jt.registerJSONType("EffectRingLayer"),jt.registerRenderer("gl",M);const Dt={animation:!0,loop:!0,url:"plane",effect:"sequence",speed:1,scale:[1,1,1],rotation:[90,0,0]},Vt={width:9,height:5};if(r.transcoders){const t=i.Map.VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){const t=r.transcoders.inject(o);i.registerWorkerAdapter("@maptalks/gltf-layer",t)}else i.registerWorkerAdapter("@maptalks/gltf-layer",(function(){return r.transcoders.inject(o)}))}else i.registerWorkerAdapter("@maptalks/gltf-layer",o);t.AEMarker=class extends bt{constructor(t,n){super(t,n);const s=e.Util.extend({},Dt,this.options.symbol);this.setSymbol(s);const i=e.Util.extend({},Vt,this.options.symbol.uniforms);this.setUniforms(i)}},t.EffectLayer=Nt,t.EffectLine=class extends bt{constructor(t,n){super(t,n);const s=e.Util.extend({},Rt,this.options.symbol);this.setSymbol(s);const i=e.Util.extend({},Bt,this.options.symbol.uniforms);this.setUniforms(i),this.setShader("effectline"),this.it="effectmarker"}getEffectType(){return"sequence"}setTexture(t){return this.setUniform("texture",t),this}setHeight(t){return this.setUniform("modelHeight",t),this}setStartOpacity(t){return this.setUniform("startOpacity",t),this}setEndOpacity(t){return this.setUniform("endOpacity",t),this}},t.EffectLineLayer=Ft,t.EffectMarker=bt,t.EffectRing=class extends st{constructor(t,n){super(t,n);const s=e.Util.extend({},Ut,this.options.symbol.uniforms);this.setUniforms(s),this.setShader("effectring"),this.it="effectring"}},t.EffectRingLayer=jt,t.GLTFLayer=Tt,t.GLTFMarker=st,t.GlowMarker=Ct,t.GlowMarkerLayer=Lt,t.MultiGLTFMarker=It,Object.defineProperty(t,"t",{value:!0}),"undefined"!=typeof console&&console.log("@maptalks/gltf-layer v0.36.1")}));
